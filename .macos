#!/usr/bin/env bash
#
# macOS Sequoia (macOS 15) compatible .macos tweaks
# Kept UI tweaks from the original .macos while avoiding deprecated/removed APIs
#
# Usage:
#   chmod +x ~/.macos-sequoia
#   sudo ~/.macos-sequoia
#
set -euo pipefail
set -x

# Require sudo up front
if [[ $EUID -ne 0 ]]; then
  echo "This script requires sudo privileges. Re-run with sudo."
  # try to re-run with sudo automatically
  exec sudo "$0" "$@"
fi

# Keep-alive: update existing `sudo` time stamp until script has finished
( while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done ) 2>/dev/null &

# Helper: macOS major version (15 for Sequoia)
MACOS_MAJOR="$(sw_vers -productVersion | cut -d. -f1)"
MACOS_VERSION="$(sw_vers -productVersion)"

echo "Detected macOS version: ${MACOS_VERSION} (major: ${MACOS_MAJOR})"

# Small helper to only run defaults write if domain/feature is present/meaningful
# Usage: safe_defaults_write <domain> <key> <type> <value...>
safe_defaults_write() {
  local domain="$1" key="$2" type="$3"
  shift 3
  # We can't easily check each key's existence, so we guard some known problem domains
  # but generally use defaults write (it is safe; macOS will create keys if needed).
  defaults write "${domain}" "${key}" ${type} "$@"
}

###############################################################################
# General UI / UX
###############################################################################

# Expand save panel by default
safe_defaults_write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
safe_defaults_write NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true

# Expand print panel by default
safe_defaults_write NSGlobalDomain PMPrintingExpandedStateForPrint -bool true
safe_defaults_write NSGlobalDomain PMPrintingExpandedStateForPrint2 -bool true

# Save to disk (not to iCloud) by default
safe_defaults_write NSGlobalDomain NSDocumentSaveNewDocumentsToCloud -bool false

# Disable automatic termination of inactive apps (if desired)
safe_defaults_write NSGlobalDomain NSDisableAutomaticTermination -bool true

# Disable the "Are you sure you want to open this application?" dialog (kind of)
# This removes quarantine-based warnings for files downloaded (you likely still get Gatekeeper).
safe_defaults_write com.apple.LaunchServices LSQuarantine -bool false

# Set highlight color (example: graphite). You can change to "0.764700 0.976500 0.568600"
safe_defaults_write NSGlobalDomain AppleHighlightColor -string "0.764700 0.976500 0.568600"

# Increase window resize speed for Cocoa (possible on many macOS versions)
safe_defaults_write NSGlobalDomain NSWindowResizeTime -float 0.001

# Disable auto-correct
safe_defaults_write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

# Show scrollbars: WhenScrolling / Automatic / Always (Possible values: "WhenScrolling", "Automatic", "Always")
safe_defaults_write NSGlobalDomain AppleShowScrollBars -string "WhenScrolling"

###############################################################################
# Trackpad, mouse, keyboard
###############################################################################

# Trackpad: enable tap to click for this user and for the login screen
safe_defaults_write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
safe_defaults_write com.apple.AppleMultitouchTrackpad Clicking -bool true
# Note: for the login screen (global)
safe_defaults_write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
safe_defaults_write NSGlobalDomain com.apple.trackpad.tapBehavior -int 1

# Enable full keyboard access (Tab in modal dialogs)
safe_defaults_write NSGlobalDomain AppleKeyboardUIMode -int 3

# Disable press-and-hold for keys in favor of key repeat
safe_defaults_write NSGlobalDomain ApplePressAndHoldEnabled -bool false

# Faster key repeat
safe_defaults_write NSGlobalDomain KeyRepeat -int 1
safe_defaults_write NSGlobalDomain InitialKeyRepeat -int 15

###############################################################################
# Dock & Mission Control
###############################################################################

# Set the icon size of Dock items
safe_defaults_write com.apple.dock tilesize -int 36

# Enable highlight hover effect for the grid view of a stack (Dock)
safe_defaults_write com.apple.dock mouse-over-hilite-stack -bool true

# Minimize windows into their application icon
safe_defaults_write com.apple.dock minimize-to-application -bool true

# Show only open applications in Dock? (uncomment to enable)
# safe_defaults_write com.apple.dock static-only -bool true

# Automatically hide and show the Dock
safe_defaults_write com.apple.dock autohide -bool true
safe_defaults_write com.apple.dock autohide-delay -float 0
safe_defaults_write com.apple.dock autohide-time-modifier -float 0.5

# Don't show recent apps in Dock
safe_defaults_write com.apple.dock show-recents -bool false

###############################################################################
# Finder
###############################################################################

# Always show file extensions
safe_defaults_write NSGlobalDomain AppleShowAllExtensions -bool true

# Show status bar and path bar in Finder
safe_defaults_write com.apple.finder ShowStatusBar -bool true
safe_defaults_write com.apple.finder ShowPathbar -bool true

# Keep folders on top when sorting by name
safe_defaults_write com.apple.finder _FXSortFoldersFirst -bool true

# Avoid creating .DS_Store files on network volumes
safe_defaults_write com.apple.desktopservices DSDontWriteNetworkStores -bool true

# Show the ~/Library folder (commonly hidden)
chflags nohidden ~/Library || true

# Show hidden files in Finder by default
safe_defaults_write com.apple.finder AppleShowAllFiles -bool true

# When performing a search, search the current folder by default
safe_defaults_write com.apple.finder FXDefaultSearchScope -string "SCcf"

# Disable the warning when changing a file extension
safe_defaults_write com.apple.finder FXEnableExtensionChangeWarning -bool false

# Use column view in all Finder windows by default
safe_defaults_write com.apple.finder FXPreferredViewStyle -string "clmv"

###############################################################################
# Screenshots
###############################################################################

# Save screenshots to ~/Desktop/Screenshots
SCREENSHOT_DIR="${HOME}/Desktop/Screenshots"
mkdir -p "${SCREENSHOT_DIR}"
safe_defaults_write com.apple.screencapture location -string "${SCREENSHOT_DIR}"

# Save screenshots in PNG format
safe_defaults_write com.apple.screencapture type -string "png"

# Disable the shadow in screenshots
safe_defaults_write com.apple.screencapture disable-shadow -bool true

###############################################################################
# Spotlight
###############################################################################

# Hide Spotlight tray-icon (if desired)
# Note: removing Spotlight icon can have unexpected effects. Keep commented unless you know you want it.
# safe_defaults_write com.apple.Spotlight MenuItemHidden -bool true

# Prevent Spotlight from indexing certain volumes (example)
/usr/bin/mdutil -i off /Volumes/External || true

###############################################################################
# Safari & WebKit
###############################################################################

# Prevent Safari from sending search queries to Apple
safe_defaults_write com.apple.Safari UniversalSearchEnabled -bool false
safe_defaults_write com.apple.Safari SuppressSearchSuggestions -bool true

# Show the full URL in Safari's address bar
safe_defaults_write com.apple.Safari ShowFullURLInSmartSearchField -bool true

# Privacy: do not send details to Apple
safe_defaults_write com.apple.Safari SendDoNotTrackHTTPHeader -bool true

# Disable the annoying backswipe (two-finger) on trackpads if you want
safe_defaults_write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2BackspaceKeyNavigationEnabled -bool false || true

###############################################################################
# Mail
###############################################################################

# Disable send and reply animations in Mail.app
safe_defaults_write com.apple.mail DisableReplyAnimations -bool true
safe_defaults_write com.apple.mail DisableSendAnimations -bool true

###############################################################################
# Bluetooth audio quality
###############################################################################

# Increase sound quality for Bluetooth headphones/headsets
# This key historically exists on modern macOS; keep but guard errors
safe_defaults_write com.apple.BluetoothAudioAgent "Apple Bitpool Min (editable)" -int 40 || true

###############################################################################
# Security & Privacy
###############################################################################

# Require password immediately after sleep or screen saver begins
safe_defaults_write com.apple.screensaver askForPassword -int 1
safe_defaults_write com.apple.screensaver askForPasswordDelay -int 0

# Disable automatic login (recommended)
safe_defaults_write /Library/Preferences/com.apple.loginwindow autoLoginUser -string ""

###############################################################################
# Time Machine
###############################################################################

# Prevent Time Machine from prompting to use new hard drives as backup volume
safe_defaults_write com.apple.TimeMachine DoNotOfferNewDisksForBackup -bool true

###############################################################################
# Bluetooth: show Bluetooth in menu bar (modern macOS handles this via control center,
# but the old menu item domain may still work in some setups)
###############################################################################
# Note: In Sequoia, the menu extras are handled differently. Toggle via UI if needed.
# However we try to add the old style if present:
MENU_EXTRAS_DIR="/System/Library/CoreServices/Menu Extras"
if [[ -d "${MENU_EXTRAS_DIR}" ]]; then
  # Add Bluetooth.menu to the menu bar extras if not present
  defaults write com.apple.systemuiserver menuExtras -array \
    "${MENU_EXTRAS_DIR}/TextInput.menu" \
    "${MENU_EXTRAS_DIR}/AirPort.menu" \
    "${MENU_EXTRAS_DIR}/Battery.menu" \
    "${MENU_EXTRAS_DIR}/Clock.menu" || true
fi

###############################################################################
# App Store / Software Update
###############################################################################

# Check for software updates daily, not just once per week
safe_defaults_write com.apple.SoftwareUpdate ScheduleFrequency -int 1

# Download newly available updates in background
safe_defaults_write com.apple.SoftwareUpdate AutomaticDownload -int 1

###############################################################################
# Miscellaneous tweaks
###############################################################################

# Disable the sound effects on boot (NVRAM changes may require SIP disabled for certain modifications)
if [[ "${MACOS_MAJOR}" -lt 14 ]]; then
  # On older macOS this used to work. Keep guard for Sequoia â€” most systems ignore it.
  nvram SystemAudioVolume=" " || true
fi

# Increase the maximum number of open file descriptors for Finder (if desired)
# NOTE: altering system limits here is nontrivial; leaving commented for safety
# sudo launchctl limit maxfiles 65536 200000

###############################################################################
# Kill affected apps so changes take effect
###############################################################################

APPS_TO_RESTART=(
  "Activity Monitor"
  "Address Book"
  "Calendar"
  "cfprefsd"
  "Contacts"
  "Dock"
  "Finder"
  "Mail"
  "Messages"
  "Photos"
  "Safari"
  "SystemUIServer"
  "Terminal"
)

echo "Attempting to restart affected apps to apply changes..."
for app in "${APPS_TO_RESTART[@]}"; do
  # Use killall, but ignore errors if app not running
  killall "${app}" 2>/dev/null || true
done

echo "Done. Some changes may require a logout/restart to take full effect."